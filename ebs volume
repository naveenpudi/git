---
- name: Launch EC2 instance and attach EBS volume
  hosts: all
  connection: local
  gather_facts: false

  tasks:

    - name: Launch EC2 instance
      amazon.aws.ec2_instance:
        aws_access_key: AKIAXKNVCS7C5ZZSN2OP
        aws_secret_key: 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
        region: us-east-2
        name: test-instance
        key_name: basha
        instance_type: t2.micro
        image_id: ami-0d1b5a8c13042c939
        wait: true
        count: 1
        network:
          subnet_id: subnet-0663a403a26bdaa55
          assign_public_ip: true
          security_group_id: sg-0470f556f631db8fb
        tags:
          Name: Ansible-Instance
      register: ec2_result

    - name: Wait 7 minutes for EC2 to fully initialize
      ansible.builtin.pause:
        minutes: 7
      when: ec2_result.instances[0].instance_id is defined

    - name: Create EBS volume
      amazon.aws.ec2_vol:
        aws_access_key: AKIAXKNVCS7C5ZZSN2OP
        aws_secret_key: 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
        region: us-east-2
        zone: "{{ ec2_result.instances[0].placement.availability_zone }}"
        volume_size: 8
        volume_type: gp2
        state: present
        tags:
          Name: Ansible-EBS
      register: ebs_volume

    - name: Attach EBS volume to instance
      amazon.aws.ec2_vol:
        aws_access_key: AKIAXKNVCS7C5ZZSN2OP
        aws_secret_key: 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
        region: us-east-2
        instance: "{{ ec2_result.instances[0].instance_id }}"
        id: "{{ ebs_volume.volume_id }}"
        device_name: /dev/xvdf
        state: present
